

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.jpg">
  <link rel="icon" href="/img/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Yuhan">
  <meta name="keywords" content="">
  
    <meta name="description" content="操作系统的课程实验，生产者-消费者问题的C语言实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="生产者-消费者问题的C语言实现">
<meta property="og:url" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="Yuhan&#39;s blog">
<meta property="og:description" content="操作系统的课程实验，生产者-消费者问题的C语言实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170622160.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170647133.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170703721.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170722493.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170725692.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130180127855.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130180507984.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130190423742.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130190738319.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130190943965.png">
<meta property="og:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130191121626.png">
<meta property="article:published_time" content="2021-11-28T16:00:00.000Z">
<meta property="article:modified_time" content="2021-12-05T03:24:23.972Z">
<meta property="article:author" content="Wu Yuhan">
<meta property="article:tag" content="操作系统实验">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://yuhan2001.github.io/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170622160.png">
  
  
  <title>生产者-消费者问题的C语言实现 - Yuhan&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://lib.baomitu.com/highlight.js/10.7.3/styles/vs2015.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"yuhan2001.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"6da93a2e5d7f160e0f40b273ddbbddac","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Yuhan&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/3.jpeg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="生产者-消费者问题的C语言实现">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-29 00:00" pubdate>
        2021年11月29日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      18k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      150 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">生产者-消费者问题的C语言实现</h1>
            
            <div class="markdown-body">
              <h1 id="实验六-生产者-消费者问题实现"><a href="#实验六-生产者-消费者问题实现" class="headerlink" title="实验六 生产者-消费者问题实现"></a>实验六 生产者-消费者问题实现</h1><h2 id="实验题目"><a href="#实验题目" class="headerlink" title="实验题目"></a>实验题目</h2><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><ul>
<li><p>在Linux操作系统下用C实现经典同步问题：生产者—消费者，具体要求如下：</p>
<p>(1) 一个大小为10的缓冲区，初始状态为空。<br>(2) 2个生产者，随机等待一段时间，往缓冲区中添加数据，若缓冲区已满，等待消费者取走数据之后再添加，重复10次。<br>(3) 2个消费者，随机等待一段时间，从缓冲区中读取数据，若缓冲区为空，等待生产者添加数据之后再读取，重复10次。</p>
</li>
</ul>
<h3 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h3><ul>
<li><p>本实验的主要目的是模拟操作系统中进程同步和互斥。在系统进程并发执行异步推进的过程中，由于资源共享和进程间合作而造成进程间相互制约。进程间的相互制约有两种不同的方式。</p>
<p>（1）间接制约。这是由于多个进程共享同一资源（如CPU、共享输入/输出设备）而引起的，即共享资源的多个进程因系统协调使用资源而相互制约。<br>（2）直接制约。只是由于进程合作中各个进程为完成同一任务而造成的，即并发进程各自的执行结果互为对方的执行条件，从而限制各个进程的执行速度。</p>
</li>
<li><p><strong>生产者和消费者是经典的进程同步问题</strong>，在这个问题中，生产者不断的向缓冲区中写入数据，而消费者则从缓冲区中读取数据。生产者进程和消费者对缓冲区的操作是互斥，即当前只能有一个进程对这个缓冲区进行操作，生产者进入操作缓冲区之前，先要看缓冲区是否已满，如果缓冲区已满，则它必须等待消费者进程将数据取出才能写入数据，同样的，消费者进程从缓冲区读取数据之前，也要判断缓冲区是否为空，如果为空，则必须等待生产者进程写入数据才能读取数据。</p>
</li>
<li><p><strong>在本实验中，进程之间要进行通信来操作同一缓冲区</strong>。一般来说，进程间的通信根据通信内容可以划分为两种：即控制信息的传送与大批量数据传送。有时，也把进程间控制信息的交换称为低级通信，而把进程间大批量数据的交换称为高级通信。目前，计算机系统中用得比较普遍的高级通信机制可分为3大类：共享存储器系统、消息传递系统及管道通信系统。</p>
<ul>
<li>共享存储器系统：共享存储器系统为了传送大量数据，在存储器中划出一块共享存储区，诸进程可通过对共享存储区进行读数据或写数据以实现通信。进程在通信之前，向系统申请共享存储区中的一个分区，并为它指定一个分区关键字。</li>
<li>消息传递系统：在消息传递系统中，进程间的数据交换以消息为单位，在计算机网络中被称为报文。消息传递系统的实现方式又可以分为以下两种：<ul>
<li>直接通信方式：发送进程可将消息直接发送给接收进程，即将消息挂在接收进程的消息缓冲队列上，而接收进程可从自己的消息缓冲队列中取得消息。</li>
<li>间接通信方式：发送进程将消息发送到指定的信箱中，而接收进程从信箱中取得消息。这种通信方式又称信箱通信方式，被广泛地应用于计算机网络中。相应地，该消息传递系统被称为电子邮件系统。</li>
</ul>
</li>
<li>管道通信系统：向管道提供输入的发送进程，以字符流方式将大量的数据送入管道，而接收进程从管道中接收数据。由于发送进程和接收进程是利用管道进行通信的，故称为管道通信。为了协调发送和接收双方的通信，管道通信机制必须提供以下3方面的协调功能：<ul>
<li>互斥：当一个进程正在对pipe文件进行读或写操作时，另一个进程必须等待。</li>
<li>同步：当写进程把一定数量的数据写入pipe文件后，便阻塞等待，直到读进程取走数据后，再把写进程唤醒。</li>
<li>确认对方是否存在：只有确定对方已存在时，才能进行管道通信，否则会造成因对方不存在而无限制地等待。</li>
</ul>
</li>
</ul>
</li>
<li><strong>在这个问题当中，我们采用信号量机制进行进程之间的通信</strong>，设置两个信号量，空的信号量和满的信号量。</li>
<li>在Linux系统中，一个或多个信号量构成一个信号量集合。使用信号量机制可以实现进程之间的同步和互斥，允许并发进程一次对一组信号量进行相同或不同的操作。每个P、V操作不限于减1或加1，而是可以加减任何整数。在进程终止时，系统可根据需要自动消除所有被进程操作过的信号量的影响。<ol>
<li>缓冲区采用循环队列表示，利用头、尾指针来存放、读取数据，以及判断队列是否为空。缓冲区中数组大小为10；</li>
<li>利用随机函数rand()得到A～Z的一个随机字符，作为生产者每次生产的数据，存放到缓冲区中；</li>
<li>使用<code>shmget()</code>系统调用实现共享主存段的创建，<code>shmget()</code>返回共享内存区的ID。对于已经申请到的共享段，进程需把它附加到自己的虚拟空间中才能对其进行读写。</li>
<li>信号量的建立采用<code>semget()</code>函数，同时建立信号量的数量。在信号量建立后，调用<code>semctl()</code>对信号量进行初始化，例如本实验中，可以建立两个信号<code>SEM_EMPTY</code>、<code>SEM_FULL</code>，初始化时设置<code>SEM_EMPTY</code>为10，<code>SEM_FULL</code>为0。使用操作信号的函数<code>semop()</code>做排除式操作，使用这个函数防止对共享内存的同时操作。对共享内存操作完毕后采用<code>shmctl()</code>函数撤销共享内存段。</li>
<li>使用循环，创建2个生产者以及2个消费者，采用函数fork()创建一个新的进程。</li>
<li>一个进程的一次操作完成后，采用函数<code>fflush()</code>刷新缓冲区。</li>
<li>程序最后使用<code>semctl()</code>函数释放内存。</li>
</ol>
</li>
</ul>
<h3 id="模拟程序的程序流程图"><a href="#模拟程序的程序流程图" class="headerlink" title="模拟程序的程序流程图"></a>模拟程序的程序流程图</h3><ol>
<li><p>主程序流程图：</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170622160.png" srcset="/img/loading.gif" lazyload alt="image-20211130170622160"></p>
</li>
</ol>
<ol>
<li><p>生产者进程流程图</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170647133.png" srcset="/img/loading.gif" lazyload alt="image-20211130170647133"></p>
</li>
<li><p>消费者进程流程图</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170703721.png" srcset="/img/loading.gif" lazyload alt="image-20211130170703721"></p>
</li>
<li><p>P操作流程图</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170722493.png" srcset="/img/loading.gif" lazyload alt="image-20211130170722493"></p>
</li>
<li><p>V操作流程图</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130170725692.png" srcset="/img/loading.gif" lazyload alt="image-20211130170725692"></p>
</li>
</ol>
<h2 id="程序中使用的数据结构及符号说明"><a href="#程序中使用的数据结构及符号说明" class="headerlink" title="程序中使用的数据结构及符号说明"></a>程序中使用的数据结构及符号说明</h2><ol>
<li><p>自定义结构体<code>buf</code>：实现循环队列</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> //循环队列</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-type">int</span> in; <span class="hljs-comment">//指向缓冲中下一个空位</span><br>	<span class="hljs-type">int</span> out; <span class="hljs-comment">//指向缓冲中第一个满位</span><br>	<span class="hljs-type">char</span> str[MAX_BUFFER_SIZE]; <span class="hljs-comment">//存放字母</span><br>	<span class="hljs-type">int</span> num; <span class="hljs-comment">//产品个数</span><br>	<span class="hljs-type">int</span> is_empty; <span class="hljs-comment">//是否为空</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bf</span>;</span> <span class="hljs-comment">//定义一个循环队列指针</span><br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>库<code>&lt;sys/time.h&gt;</code>中的结构体<code>timeval</code>：实现时间</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">struct timeval</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    time_t      tv_sec;     //seconds </span><br><span class="hljs-comment">    suseconds_t tv_usec;    //icroseconds </span><br><span class="hljs-comment">&#125;;</span><br><span class="hljs-comment">*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">start</span>;</span> <span class="hljs-comment">//开始时间</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">now</span>;</span> <span class="hljs-comment">//当前时间</span><br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>库<code>&lt;sys/sem.h&gt;</code>中的结构体<code>sembuf</code>：对信号量操作</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">struct sembuf</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    unsigned short int sem_num;    //信号量编号</span><br><span class="hljs-comment">    short int sem_op;              //对信号量的操作</span><br><span class="hljs-comment">    short int sem_flg;             //通常设为SEM_UNDO</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sb</span>;</span><br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>整型</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//缓冲区大小</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_BUFFER_SIZE 10</span><br><span class="hljs-comment">//共享内存和信号量：当前用户的进程可读写</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_MODE 0600</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEM_MODE 0600</span><br><span class="hljs-comment">//信号量的键值</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEM_FULL 1     <span class="hljs-comment">//信号量 1 --- full</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEM_EMPTY 2    <span class="hljs-comment">//信号量 2 --- empty </span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MUTEX 3        <span class="hljs-comment">//信号量 3 --- 互斥量</span></span><br><span class="hljs-comment">//共享内存的键值</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SHMKEY 75</span><br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Consumer = <span class="hljs-number">2</span>; <span class="hljs-comment">//消费者数量</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Producer = <span class="hljs-number">2</span>; <span class="hljs-comment">//生产者数量</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Buffer = <span class="hljs-number">10</span>; <span class="hljs-comment">//缓冲区大小</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Worktime = <span class="hljs-number">10</span>; <span class="hljs-comment">//每个进程执行的次数</span><br><span class="hljs-type">int</span> shm_id; <span class="hljs-comment">//shmget函数返回的共享内存标识符</span><br><span class="hljs-type">int</span> full, empty, mutex; <span class="hljs-comment">//semget函数返回的信号量标识符</span><br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>void指针</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">void</span> *addr; <span class="hljs-comment">//地址指针，连接共享内存段的地址空间</span><br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>自定义函数（实现详见下方代码）：</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">get_rand_num</span><span class="hljs-params">()</span> <span class="hljs-comment">//0~99 随机数</span><br><span class="hljs-type">char</span> <span class="hljs-title function_">get_rand_letter</span><span class="hljs-params">()</span> <span class="hljs-comment">//随机生成A~Z</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Wait</span><span class="hljs-params">(<span class="hljs-type">int</span> sem_id)</span> <span class="hljs-comment">//P操作</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Signal</span><span class="hljs-params">(<span class="hljs-type">int</span> sem_id)</span> <span class="hljs-comment">//V操作</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">printTime</span><span class="hljs-params">()</span> <span class="hljs-comment">//输出时间</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Producer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buf *bf)</span> <span class="hljs-comment">//生产者操作</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Consumer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buf *bf)</span> <span class="hljs-comment">//消费者操作</span><br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p><strong>各类库中的关键函数</strong></p>
<ul>
<li><p><code>&lt;sys/shm.h&gt;</code>中：</p>
<ul>
<li><p><code>shmget()</code>函数：用来创建共享内存。</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">shmget</span><span class="hljs-params">(<span class="hljs-type">key_t</span> key, <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> shmflg)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>第一个参数：键值key有效地为共享内存段命名。</li>
<li>第二个参数：size以字节为单位指定需要共享的内存容量。</li>
<li>第三个参数：shmflg是权限标志，如果要想在key标识的共享内存不存在时创建，需要与IPC_CREAT做或操作。如0644,它表示允许一个进程创建的共享内存被内存创建者所拥有的进程向共享内存读取和写入数据，同时其他用户创建的进程只能读取共享内存。</li>
<li>调用成功时返回一个与key相关的共享内存标识符（非负整数），用于后续的共享内存函数。调用失败返回-1.</li>
</ul>
</li>
<li><p><code>shmat()</code>函数：启动对该共享内存的访问，并把共享内存连接到当前进程的地址空间。</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">shmat</span><span class="hljs-params">(<span class="hljs-type">int</span> shm_id, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *shm_addr, <span class="hljs-type">int</span> shmflg)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>第一个参数：shm_id是由shmget()函数返回的共享内存标识。</li>
<li>第二个参数：shm_addr指定共享内存连接到当前进程中的地址位置，通常为空，表示让系统来选择共享内存的地址。</li>
<li>第三个参数：shm_flg是一组标志位，通常为0。</li>
<li>调用成功时返回一个指向共享内存第一个字节的指针，如果调用失败返回-1。</li>
</ul>
</li>
<li><p><code>shmdt()</code>函数：用于将共享内存从当前进程中分离。</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">shmdt</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *shmaddr)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>参数：shmaddr是shmat()函数返回的地址指针。</li>
<li>调用成功时返回0，失败时返回-1。</li>
</ul>
</li>
<li><p><code>shmctl()</code>函数：用来控制共享内存。</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">shmctl</span><span class="hljs-params">(<span class="hljs-type">int</span> shm_id, <span class="hljs-type">int</span> command, <span class="hljs-keyword">struct</span> shmid_ds *buf)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>第一个参数：shm_id是shmget()函数返回的共享内存标识符。</li>
<li>第二个参数：command是要采取的操作，它可以取下面的三个值:<ul>
<li>IPC_STAT：把shmid_ds结构中的数据设置为共享内存的当前关联值，即用共享内存的当前关联值覆盖shmid_ds的值；</li>
<li>IPC_SET：如果进程有足够的权限，就把共享内存的当前关联值设置为shmid_ds结构中给出的值；</li>
<li>IPC_RMID：删除共享内存段。</li>
</ul>
</li>
<li>第三个参数：buf是一个结构指针，它指向共享内存模式和访问权限的结构。</li>
<li>调用成功时返回0，失败时返回-1。</li>
</ul>
</li>
</ul>
</li>
<li><p><code>&lt;sys/sem.h&gt;</code>中：</p>
<ul>
<li><p><code>semget()</code>函数：创建一个新的信号量集</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">semget</span><span class="hljs-params">(<span class="hljs-type">key_t</span> key,<span class="hljs-type">int</span> nsems,<span class="hljs-type">int</span> semflg)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>第一个参数：键值key有效地为信号量（集）命名。</li>
<li>第二个参数：一个新的信号量集中应该创建的信号量的个数。单个信号量则为1。</li>
<li>第三个参数：权限位，如果要想在key标识的信号量不存在时创建，需要与IPC_CREAT做或操作。</li>
<li>调用成功则返回信号量集的IPC标识符，失败则返回-1。</li>
</ul>
</li>
<li><p><code>semctl()</code>函数：用来控制信号量</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">semctl</span><span class="hljs-params">(<span class="hljs-type">int</span> semid,<span class="hljs-type">int</span> semnum,<span class="hljs-type">int</span> cmd,<span class="hljs-keyword">union</span> semun arg)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li><p>第一个参数：sem_id是semget()函数返回的信号量标识符。</p>
</li>
<li><p>第二个参数：semnum是信号量编号，当要用到信号量集时才用到。单个信号量则为0。</p>
</li>
<li><p>第三个参数：cmd是要采取的操作，它可以取下面的几个值:</p>
<ul>
<li><p>IPC_STAT（或STAT）：获得该信号量（或信号量集）的semid_ds结构（描述信号量的结构），并存放在第四个参数arg结构变量的buf域指向的semid_ds结构中。</p>
</li>
<li><p>IPC_SETVAL（或SETVAL）：将信号量值设置为arg的值。</p>
</li>
<li><p>IPC_GETVAL （或GETVAL）：返回信号量的当前值。</p>
</li>
<li><p>IPC_RMID：删除信号量。</p>
</li>
</ul>
</li>
<li><p>调用成功时根据cmd值的不同返回不同值，失败时返回-1。</p>
</li>
</ul>
</li>
<li><p><code>semop()</code>函数：对信号量进行操作</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">semop</span><span class="hljs-params">(<span class="hljs-type">int</span> semid,<span class="hljs-keyword">struct</span> sembuf*sops,<span class="hljs-type">size_t</span> nsops )</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li><p>第一个参数：sem_id是semget()函数返回的信号量标识符。</p>
</li>
<li><p>第二个参数：sops指向信号量操作结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> <span class="hljs-type">int</span> sem_num;    <span class="hljs-comment">//信号量编号</span><br>    <span class="hljs-type">short</span> <span class="hljs-type">int</span> sem_op;              <span class="hljs-comment">//对信号量的操作(-1:P +1:V)</span><br>    <span class="hljs-type">short</span> <span class="hljs-type">int</span> sem_flg;             <span class="hljs-comment">//通常设为SEM_UNDO</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<div class="hljs code-wrapper"><pre><code class="hljs">   - 第三个参数：nsop是sops中的操作个数，通常为1，代表单个操作。

   - 调用成功时返回信号量标识符，失败时返回-1。
</code></pre></div><h2 id="源程序并附上注释"><a href="#源程序并附上注释" class="headerlink" title="源程序并附上注释"></a>源程序并附上注释</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-comment">//缓冲区大小</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_BUFFER_SIZE 10</span><br><span class="hljs-comment">//共享内存和信号量：当前用户的进程可读写</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_MODE 0600</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEM_MODE 0600</span><br><br><span class="hljs-comment">//信号量的键值</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEM_FULL 1     <span class="hljs-comment">//信号量 1 --- full</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEM_EMPTY 2    <span class="hljs-comment">//信号量 2 --- empty </span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MUTEX 3        <span class="hljs-comment">//信号量 3 --- 互斥量</span></span><br><span class="hljs-comment">//共享内存的键值</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SHMKEY 75</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> //循环队列</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-type">int</span> in; <span class="hljs-comment">//指向缓冲中下一个空位</span><br>	<span class="hljs-type">int</span> out; <span class="hljs-comment">//指向缓冲中第一个满位</span><br>	<span class="hljs-type">char</span> str[MAX_BUFFER_SIZE]; <span class="hljs-comment">//存放字母</span><br>	<span class="hljs-type">int</span> num; <span class="hljs-comment">//产品个数</span><br>	<span class="hljs-type">int</span> is_empty; <span class="hljs-comment">//是否为空</span><br>&#125;;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Consumer = <span class="hljs-number">2</span>; <span class="hljs-comment">//消费者数量</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Producer = <span class="hljs-number">2</span>; <span class="hljs-comment">//生产者数量</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Buffer = <span class="hljs-number">10</span>; <span class="hljs-comment">//缓冲区大小</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Worktime = <span class="hljs-number">10</span>; <span class="hljs-comment">//每个进程执行的次数</span><br><span class="hljs-type">int</span> shm_id; <span class="hljs-comment">//shmget函数返回的共享内存标识符</span><br><span class="hljs-type">int</span> full, empty, mutex; <span class="hljs-comment">//semget函数返回的信号量标识符</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">start</span>;</span> <span class="hljs-comment">//开始时间</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">now</span>;</span> <span class="hljs-comment">//当前时间</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_rand_num</span><span class="hljs-params">()</span> <span class="hljs-comment">//0~99 随机数</span><br>&#123;<br>	gettimeofday(&amp;now, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-type">int</span> digit;<br>	srand((<span class="hljs-type">unsigned</span>)(now.tv_usec)); <span class="hljs-comment">//当前时间（微秒）作为随机数种子</span><br>	digit = rand() % <span class="hljs-number">100</span>;<br>	<span class="hljs-keyword">return</span> digit;<br>&#125;<br><br><span class="hljs-type">char</span> <span class="hljs-title function_">get_rand_letter</span><span class="hljs-params">()</span> <span class="hljs-comment">//随机生成A~Z</span><br>&#123;<br>	gettimeofday(&amp;now, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-type">char</span> letter;<br>	srand((<span class="hljs-type">unsigned</span>)(now.tv_usec));<br>	letter = (<span class="hljs-type">char</span>)((rand() % <span class="hljs-number">26</span>) + <span class="hljs-string">&#x27;A&#x27;</span>);<br>	<span class="hljs-keyword">return</span> letter;<br>&#125;<br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">//信号量操作结构体(在sys/sem.h中定义)</span><br><span class="hljs-comment">struct sembuf</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    unsigned short int sem_num;    //信号量编号</span><br><span class="hljs-comment">    short int sem_op;              //对信号量的操作</span><br><span class="hljs-comment">    short int sem_flg;             //通常设为SEM_UNDO</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Wait</span><span class="hljs-params">(<span class="hljs-type">int</span> sem_id)</span> <span class="hljs-comment">//P操作</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sb</span>;</span><br>	sb.sem_num = <span class="hljs-number">0</span>;<br>	sb.sem_op = <span class="hljs-number">-1</span>; <span class="hljs-comment">//Wait(-1)</span><br>	sb.sem_flg = SEM_UNDO;<br>	<span class="hljs-keyword">if</span> (semop(sem_id, &amp;sb, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//P操作，判断是否成功</span><br>	&#123;<br>		perror(<span class="hljs-string">&quot;P操作失败！\n&quot;</span>); <span class="hljs-comment">//输出错误信息</span><br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Signal</span><span class="hljs-params">(<span class="hljs-type">int</span> sem_id)</span> <span class="hljs-comment">//V操作</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sb</span>;</span><br>	sb.sem_num = <span class="hljs-number">0</span>;<br>	sb.sem_op = <span class="hljs-number">1</span>; <span class="hljs-comment">//Signal(+1)</span><br>	sb.sem_flg = SEM_UNDO;<br>	<span class="hljs-keyword">if</span> (semop(sem_id, &amp;sb, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//V操作，判断是否成功</span><br>	&#123;<br>		perror(<span class="hljs-string">&quot;V操作失败！\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">printTime</span><span class="hljs-params">()</span> <span class="hljs-comment">//输出时间</span><br>&#123;<br>	gettimeofday(&amp;now, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-type">double</span> difference = ((<span class="hljs-type">double</span>)now.tv_usec - (<span class="hljs-type">double</span>)start.tv_usec) / <span class="hljs-number">1000000</span>;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;| %8.4fs    | &quot;</span>, difference);<br>&#125;<br><br><span class="hljs-comment">//生产者操作</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Producer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buf *bf)</span><br>&#123;<br>	<span class="hljs-type">int</span> i, j;<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N_Producer; i++) <span class="hljs-comment">//使用循环创建进程</span><br>	&#123;<br>		<span class="hljs-type">int</span> pid = fork(); <span class="hljs-comment">//创建子进程</span><br>		<span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)<br>		&#123;<br>			perror(<span class="hljs-string">&quot;创建进程失败\n&quot;</span>);<br>			<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-type">void</span> *addr;<br>			addr = shmat(shm_id, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>			bf = (<span class="hljs-keyword">struct</span> buf *) addr;<br>			<span class="hljs-keyword">if</span> (bf == (<span class="hljs-type">void</span> *) - <span class="hljs-number">1</span>)<br>			&#123;<br>				perror(<span class="hljs-string">&quot;连接共享内存失败！\n&quot;</span>);<br>				<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>			&#125;<br>			<span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; N_Worktime; j++) <span class="hljs-comment">//每个进程操作10次</span><br>			&#123;<br>				Wait(empty);<br>				Wait(mutex);<br>				<span class="hljs-comment">//随机等待一段时间(0~99微秒)</span><br>				usleep(get_rand_num());<br>				<span class="hljs-comment">//向缓冲区添加数据</span><br>				<span class="hljs-type">char</span> c = get_rand_letter();<br>				bf-&gt;str[bf-&gt;in] = c;<br>				bf-&gt;in = (bf-&gt;in + <span class="hljs-number">1</span>) % MAX_BUFFER_SIZE;<br>				bf-&gt;is_empty = <span class="hljs-number">0</span>;<br>				bf-&gt;num++;<br>				<span class="hljs-type">int</span> first, last;<br>				<span class="hljs-comment">//打印时间</span><br>				printTime();<br>				<span class="hljs-comment">//打印缓冲区数据</span><br>				<span class="hljs-keyword">if</span> (bf-&gt;in - <span class="hljs-number">1</span> &gt;= bf-&gt;out)<br>					last = bf-&gt;in - <span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">else</span><br>					last = bf-&gt;in - <span class="hljs-number">1</span> + MAX_BUFFER_SIZE;<br>				<span class="hljs-keyword">for</span> (first = bf-&gt;out; bf-&gt;num&gt;<span class="hljs-number">0</span>&amp;&amp;first &lt;= last; first++)<br>				&#123;<br>					<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c &quot;</span>, bf-&gt;str[first % MAX_BUFFER_SIZE]);<br>				&#125;<br>				<span class="hljs-type">int</span> k;<br>				<span class="hljs-keyword">for</span> (k = bf-&gt;num; k &lt;= MAX_BUFFER_SIZE; k++)<br>				&#123;<br>					<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  &quot;</span>);<br>				&#125;<br>				<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;|&quot;</span>);<br>				<span class="hljs-comment">//打印进程编号和产生数据</span><br>				<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;   生产者进程%d  |      生产%c       |\n&quot;</span>, i, c);<br>				<span class="hljs-comment">//刷新缓冲区</span><br>				fflush(<span class="hljs-built_in">stdout</span>);<br>				Signal(mutex);<br>				Signal(full);<br>			&#125;<br>			<span class="hljs-comment">//取消对共享内存段的连接</span><br>			shmdt(addr);<br>			<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">//消费者操作</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Consumer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buf *bf)</span><br>&#123;<br>	<span class="hljs-type">int</span> i, j;<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N_Producer; i++) <span class="hljs-comment">//使用循环创建进程</span><br>	&#123;<br>		<span class="hljs-type">int</span> pid = fork(); <span class="hljs-comment">//创建子进程</span><br>		<span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)<br>		&#123;<br>			perror(<span class="hljs-string">&quot;创建进程失败\n&quot;</span>);<br>			<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-type">void</span> *addr;<br>			addr = shmat(shm_id, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>			bf = (<span class="hljs-keyword">struct</span> buf *) addr;<br>			<span class="hljs-keyword">if</span> (bf == (<span class="hljs-type">void</span> *) - <span class="hljs-number">1</span>)<br>			&#123;<br>				perror(<span class="hljs-string">&quot;连接共享内存失败！\n&quot;</span>);<br>				<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>			&#125;<br>			<span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; N_Worktime; j++) <span class="hljs-comment">//每个进程操作10次</span><br>			&#123;<br>				Wait(full);<br>				Wait(mutex);<br>				<span class="hljs-comment">//随机等待一段时间(0~99微秒)</span><br>				usleep(get_rand_num());<br>				<span class="hljs-comment">//从缓冲区取走数据</span><br>				<span class="hljs-type">char</span> c = bf-&gt;str[bf-&gt;out];<br>				bf-&gt;out = (bf-&gt;out + <span class="hljs-number">1</span>) % MAX_BUFFER_SIZE;<br>				bf-&gt;is_empty = (bf-&gt;out == bf-&gt;in);<br>				bf-&gt;num--;<br>				<span class="hljs-type">int</span> first, last;<br>				<span class="hljs-comment">//打印时间</span><br>				printTime();<br>				<span class="hljs-comment">//打印缓冲区数据</span><br>				<span class="hljs-keyword">if</span> (bf-&gt;in - <span class="hljs-number">1</span> &gt;= bf-&gt;out)<br>					last = bf-&gt;in - <span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">else</span><br>					last = bf-&gt;in - <span class="hljs-number">1</span> + MAX_BUFFER_SIZE;<br>				<span class="hljs-keyword">for</span> (first = bf-&gt;out; bf-&gt;num&gt;<span class="hljs-number">0</span>&amp;&amp;first &lt;= last; first++)<br>				&#123;<br>					<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c &quot;</span>, bf-&gt;str[first % MAX_BUFFER_SIZE]);<br>				&#125;<br>				<span class="hljs-type">int</span> k;<br>				<span class="hljs-keyword">for</span> (k = bf-&gt;num; k &lt;= MAX_BUFFER_SIZE; k++)<br>				&#123;<br>					<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  &quot;</span>);<br>				&#125;<br>				<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;|&quot;</span>);<br>				<span class="hljs-comment">//打印进程编号和消费数据</span><br>				<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;   消费者进程%d  |      消费%c       |\n&quot;</span>, i, c);<br>				<span class="hljs-comment">//刷新缓冲区</span><br>				fflush(<span class="hljs-built_in">stdout</span>);<br>				Signal(mutex);<br>				Signal(empty);<br>			&#125;<br>			<span class="hljs-comment">//取消对共享内存段的连接</span><br>			shmdt(addr);<br>			<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;| 进程执行时间 |      缓冲区数据       | 当前执行的进程 | 产生或消费的数据 |\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------------------------------------------------------------------------\n&quot;</span>);<br>	gettimeofday(&amp;start, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//获取开始运行的时间（1970年1月1日到现在的秒和微秒）</span><br>	shm_id = shmget(SHMKEY, MAX_BUFFER_SIZE, IPC_CREAT | SHM_MODE); <span class="hljs-comment">//创建共享内存</span><br>	<span class="hljs-keyword">if</span> (shm_id &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;共享内存创建失败\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bf</span>;</span> <span class="hljs-comment">//定义一个循环队列指针</span><br>	<span class="hljs-comment">//将共享内存段连接到一个进程的地址空间中</span><br>	<span class="hljs-type">void</span> *addr;<br>	addr = shmat(shm_id, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>	bf = (<span class="hljs-keyword">struct</span> buf *) addr;<br>	<span class="hljs-keyword">if</span> (bf == (<span class="hljs-type">void</span> *) <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;连接共享内存失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">//创建3个信号量</span><br>	<span class="hljs-keyword">if</span> ((full = semget(SEM_FULL, <span class="hljs-number">1</span>, IPC_CREAT | SEM_MODE)) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建信号量SEM_FULL失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((empty = semget(SEM_EMPTY, <span class="hljs-number">1</span>, IPC_CREAT | SEM_MODE)) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建信号量SEM_EMPTY失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((mutex = semget(MUTEX, <span class="hljs-number">1</span>, IPC_CREAT | SEM_MODE)) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建信号量MUTEX失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-comment">//设置3个信号量</span><br>	<span class="hljs-keyword">if</span> (semctl(full, <span class="hljs-number">0</span>, SETVAL, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) <span class="hljs-comment">//SEM_FULL-&gt;0</span><br>	&#123;<br>		perror(<span class="hljs-string">&quot;SEM_FULL设置失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (semctl(empty, <span class="hljs-number">0</span>, SETVAL, <span class="hljs-number">10</span>) == <span class="hljs-number">-1</span>) <span class="hljs-comment">//SEM_EMPTY-&gt;10</span><br>	&#123;<br>		perror(<span class="hljs-string">&quot;SEM_EMPTY设置失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (semctl(mutex, <span class="hljs-number">0</span>, SETVAL, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>) <span class="hljs-comment">//MUTEX-&gt;1</span><br>	&#123;<br>		perror(<span class="hljs-string">&quot;MUTEX设置失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">//初始化缓冲区</span><br>	<span class="hljs-built_in">memset</span>(bf-&gt;str,<span class="hljs-string">&#x27;\0&#x27;</span>,<span class="hljs-keyword">sizeof</span>(bf-&gt;str));<br>	bf-&gt;out = <span class="hljs-number">0</span>;<br>	bf-&gt;in = <span class="hljs-number">0</span>;<br>	bf-&gt;is_empty = <span class="hljs-number">1</span>;<br>	bf-&gt;num = <span class="hljs-number">0</span>;<br>	Producer(bf);<br>	Consumer(bf);<br>	<span class="hljs-comment">//等待程序结束</span><br>	<span class="hljs-keyword">while</span> (wait(<span class="hljs-number">0</span>) != <span class="hljs-number">-1</span>);<br>	<span class="hljs-comment">//取消对共享内存的连接</span><br>	shmdt(addr);<br>	<span class="hljs-comment">//删除共享内存段</span><br>	shmctl(shm_id, IPC_RMID, <span class="hljs-number">0</span>);<br>	<span class="hljs-comment">//撤销信号量</span><br>	shmctl(full, IPC_RMID, <span class="hljs-number">0</span>);<br>	shmctl(empty, IPC_RMID, <span class="hljs-number">0</span>);<br>	shmctl(mutex, IPC_RMID, <span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------------------------------------------------------------------------\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;程序结束!\n&quot;</span>);<br>	fflush(<span class="hljs-built_in">stdout</span>);<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130180127855.png" srcset="/img/loading.gif" lazyload alt="image-20211130180127855"></p>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><p>以上是通过进程来实现生产者和消费者问题，考虑如何采用线程来实现。</p>
<ul>
<li>相比于进程实现，线程实现有以下几个不同：<ul>
<li>进程实现主要使用fork()来实现创建进程，而线程实现主要使用库<pthread.h>来实现线程。</pthread.h></li>
<li>线程间通信无需共享内存，故无需库<sys shm.h>，循环数组buf也不需要定义成指针指向地址空间。</sys></li>
<li>进程的信号量通过库<sys sem.h>实现，而线程的信号量是通过库<semaphore.h>实现的。</semaphore.h></sys></li>
</ul>
</li>
</ul>
<h3 id="主要的库函数"><a href="#主要的库函数" class="headerlink" title="主要的库函数"></a>主要的库函数</h3><ul>
<li><p><pthread.h>中：</pthread.h></p>
<ul>
<li><p><code>pthread_t</code>：声明线程标识符。</p>
</li>
<li><p><code>pthread_create()</code>函数：用于创建线程。</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_create</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> *tidp,<span class="hljs-type">const</span> <span class="hljs-type">pthread_attr_t</span> *attr,<span class="hljs-type">void</span> *(*start_rtn)(<span class="hljs-type">void</span>*),<span class="hljs-type">void</span> *arg)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>第一个参数是指向线程标识符的指针。</li>
<li>第二个参数指定各种不同的线程属性，可以为NULL。</li>
<li>第三个参数是<strong>线程运行函数</strong>的起始地址。</li>
<li>第四个参数是运行函数的参数。</li>
</ul>
</li>
<li><p><code>pthread_join</code>用来等待一个线程的结束,线程间同步的操作 </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_join</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> thread, <span class="hljs-type">void</span> **retval)</span>;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>第一个参数为线程标识符，即线程ID。</li>
<li>第二个参数retval为用户定义的指针，用来存储线程的返回值。</li>
</ul>
</li>
</ul>
</li>
<li><p><semaphore.h>中：</semaphore.h></p>
<ul>
<li><p><code>sem_t</code>：信号量的数据类型。</p>
</li>
<li><p><code>sem_init()</code>函数：信号量初始化</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">sem_init(<span class="hljs-type">sem_t</span> *sem, <span class="hljs-type">int</span> pshared, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value);<br></code></pre></div></td></tr></table></figure>
<ul>
<li>第一个参数*sem是对应的信号量。</li>
<li>第二个参数pshared：0表⽰线程间共享，非0表示进程间共享。</li>
<li>第三个参数value是信号量初值，大于0表示才可以访问。</li>
</ul>
</li>
<li><p><code>sem_wait()</code>函数：P操作。</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sem_wait</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem)</span>;<br></code></pre></div></td></tr></table></figure>
</li>
<li><p><code>sem_post()</code>函数：V操作</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sem_post</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> *sem)</span>;<br></code></pre></div></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="源程序并附上注释-1"><a href="#源程序并附上注释-1" class="headerlink" title="源程序并附上注释"></a>源程序并附上注释</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-comment">//缓冲区大小</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_BUFFER_SIZE 10</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> //循环队列</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-type">int</span> in; <span class="hljs-comment">//指向缓冲中下一个空位</span><br>	<span class="hljs-type">int</span> out; <span class="hljs-comment">//指向缓冲中第一个满位</span><br>	<span class="hljs-type">char</span> str[MAX_BUFFER_SIZE]; <span class="hljs-comment">//存放字母</span><br>	<span class="hljs-type">int</span> num; <span class="hljs-comment">//产品个数</span><br>	<span class="hljs-type">int</span> is_empty; <span class="hljs-comment">//是否为空</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> <span class="hljs-title">bf</span>;</span> <span class="hljs-comment">//定义一个循环队列</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Consumer = <span class="hljs-number">2</span>; <span class="hljs-comment">//消费者数量</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Producer = <span class="hljs-number">2</span>; <span class="hljs-comment">//生产者数量</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Buffer = <span class="hljs-number">10</span>; <span class="hljs-comment">//缓冲区大小</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N_Worktime = <span class="hljs-number">10</span>; <span class="hljs-comment">//每个进程执行的次数</span><br><span class="hljs-type">sem_t</span> full, empty, mutex; <span class="hljs-comment">//三个信号量</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">start</span>;</span> <span class="hljs-comment">//开始时间</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">now</span>;</span> <span class="hljs-comment">//当前时间</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_rand_num</span><span class="hljs-params">()</span> <span class="hljs-comment">//0~99 随机数</span><br>&#123;<br>	gettimeofday(&amp;now, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-type">int</span> digit;<br>	srand((<span class="hljs-type">unsigned</span>)(now.tv_usec)); <span class="hljs-comment">//当前时间（微秒）作为随机数种子</span><br>	digit = rand() % <span class="hljs-number">100</span>;<br>	<span class="hljs-keyword">return</span> digit;<br>&#125;<br><br><span class="hljs-type">char</span> <span class="hljs-title function_">get_rand_letter</span><span class="hljs-params">()</span> <span class="hljs-comment">//随机生成A~Z</span><br>&#123;<br>	gettimeofday(&amp;now, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-type">char</span> letter;<br>	srand((<span class="hljs-type">unsigned</span>)(now.tv_usec));<br>	letter = (<span class="hljs-type">char</span>)((rand() % <span class="hljs-number">26</span>) + <span class="hljs-string">&#x27;A&#x27;</span>);<br>	<span class="hljs-keyword">return</span> letter;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Wait</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> &amp;sem)</span> <span class="hljs-comment">//P操作</span><br>&#123;<br>	sem_wait(&amp;sem);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Signal</span><span class="hljs-params">(<span class="hljs-type">sem_t</span> &amp;sem)</span> <span class="hljs-comment">//V操作</span><br>&#123;<br>	sem_post(&amp;sem);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">printTime</span><span class="hljs-params">()</span> <span class="hljs-comment">//输出时间</span><br>&#123;<br>	gettimeofday(&amp;now, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-type">double</span> difference = ((<span class="hljs-type">double</span>)now.tv_usec - (<span class="hljs-type">double</span>)start.tv_usec) / <span class="hljs-number">1000000</span>;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;| %8.4fs    | &quot;</span>, difference);<br>&#125;<br><br><span class="hljs-comment">//生产者操作</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">Producer</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	<span class="hljs-type">int</span> i,j;<br>	<span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; N_Worktime; j++) <span class="hljs-comment">//每个线程操作10次</span><br>	&#123;<br>		Wait(empty);<br>		Wait(mutex);<br>		<span class="hljs-comment">//随机等待一段时间(0~99微秒)</span><br>		usleep(get_rand_num());<br>		<span class="hljs-comment">//向缓冲区添加数据</span><br>		<span class="hljs-type">char</span> c = get_rand_letter();<br>		bf.str[bf.in] = c;<br>		bf.in = (bf.in + <span class="hljs-number">1</span>) % MAX_BUFFER_SIZE;<br>		bf.is_empty = <span class="hljs-number">0</span>;<br>		bf.num++;<br>		<span class="hljs-type">int</span> first, last;<br>		<span class="hljs-comment">//打印时间</span><br>		printTime();<br>		<span class="hljs-comment">//打印缓冲区数据</span><br>		<span class="hljs-keyword">if</span> (bf.in - <span class="hljs-number">1</span> &gt;= bf.out)<br>			last = bf.in - <span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">else</span><br>			last = bf.in - <span class="hljs-number">1</span> + MAX_BUFFER_SIZE;<br>		<span class="hljs-keyword">for</span> (first = bf.out; bf.num&gt;<span class="hljs-number">0</span>&amp;&amp;first &lt;= last; first++)<br>		&#123;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c &quot;</span>, bf.str[first % MAX_BUFFER_SIZE]);<br>		&#125;<br>		<span class="hljs-type">int</span> k;<br>		<span class="hljs-keyword">for</span> (k = bf.num; k &lt;= MAX_BUFFER_SIZE; k++)<br>		&#123;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  &quot;</span>);<br>		&#125;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;|&quot;</span>);<br>		<span class="hljs-comment">//打印进程编号和产生数据</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;   生产者线程%d  |      生产%c       |\n&quot;</span>,*(<span class="hljs-type">int</span>*)arg, c);<br>		Signal(mutex);<br>		Signal(full);<br>	&#125;<br>	<span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//消费者操作</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">Consumer</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	<span class="hljs-type">int</span> i, j;<br>	<span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; N_Worktime; j++) <span class="hljs-comment">//每个线程操作10次</span><br>	&#123;<br>		Wait(full);<br>		Wait(mutex);<br>		<span class="hljs-comment">//随机等待一段时间(0~99微秒)</span><br>		usleep(get_rand_num());<br>		<span class="hljs-comment">//从缓冲区取走数据</span><br>		<span class="hljs-type">char</span> c = bf.str[bf.out];<br>		bf.out = (bf.out + <span class="hljs-number">1</span>) % MAX_BUFFER_SIZE;<br>		bf.is_empty = (bf.out == bf.in);<br>		bf.num--;<br>		<span class="hljs-type">int</span> first, last;<br>		<span class="hljs-comment">//打印时间</span><br>		printTime();<br>		<span class="hljs-comment">//打印缓冲区数据</span><br>		<span class="hljs-keyword">if</span> (bf.in - <span class="hljs-number">1</span> &gt;= bf.out)<br>			last = bf.in - <span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">else</span><br>			last = bf.in - <span class="hljs-number">1</span> + MAX_BUFFER_SIZE;<br>		<span class="hljs-keyword">for</span> (first = bf.out; bf.num&gt;<span class="hljs-number">0</span>&amp;&amp;first &lt;= last; first++)<br>		&#123;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c &quot;</span>, bf.str[first % MAX_BUFFER_SIZE]);<br>		&#125;<br>		<span class="hljs-type">int</span> k;<br>		<span class="hljs-keyword">for</span> (k = bf.num; k &lt;= MAX_BUFFER_SIZE; k++)<br>		&#123;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  &quot;</span>);<br>		&#125;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;|&quot;</span>);<br>		<span class="hljs-comment">//打印进程编号和消费数据</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;   消费者线程%d  |      消费%c       |\n&quot;</span>, *(<span class="hljs-type">int</span>*)arg, c);<br>		Signal(mutex);<br>		Signal(empty);<br>	&#125;<br>	<span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;| 线程执行时间 |      缓冲区数据       | 当前执行的线程 | 产生或消费的数据 |\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------------------------------------------------------------------------\n&quot;</span>);<br>	gettimeofday(&amp;start, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//获取开始运行的时间（1970年1月1日到现在的秒和微秒）</span><br><br>	<span class="hljs-comment">//创建并初始化3个信号量</span><br>	<span class="hljs-keyword">if</span> (sem_init(&amp;full, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建信号量SEM_FULL失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (sem_init(&amp;empty, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建信号量SEM_EMPTY失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (sem_init(&amp;mutex, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建信号量MUTEX失败!\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">//初始化缓冲区</span><br><br>	<span class="hljs-built_in">memset</span>(bf.str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(bf.str));<br>	bf.out = <span class="hljs-number">0</span>;<br>	bf.in = <span class="hljs-number">0</span>;<br>	bf.is_empty = <span class="hljs-number">1</span>;<br>	bf.num = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">//定义4个线程</span><br>	<span class="hljs-type">pthread_t</span> producer0;<br>	<span class="hljs-type">pthread_t</span> producer1;<br>	<span class="hljs-type">pthread_t</span> consumer0;<br>	<span class="hljs-type">pthread_t</span> consumer1;<br><br>	<span class="hljs-type">int</span> arg0 = <span class="hljs-number">0</span>, arg1 = <span class="hljs-number">1</span>; <span class="hljs-comment">//传入函数的参数（代表进程编号）</span><br><br>	<span class="hljs-comment">//创建线程</span><br>	<span class="hljs-keyword">if</span> (pthread_create(&amp;producer0, <span class="hljs-literal">NULL</span>, Producer, &amp;arg0) != <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建生产者线程失败！\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (pthread_create(&amp;producer1, <span class="hljs-literal">NULL</span>, Producer, &amp;arg1) != <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建生产者线程失败！\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (pthread_create(&amp;consumer0, <span class="hljs-literal">NULL</span>, Consumer, &amp;arg0) != <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建消费者线程失败！\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (pthread_create(&amp;consumer1, <span class="hljs-literal">NULL</span>, Consumer, &amp;arg1) != <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;创建消费者线程失败！\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-comment">//ret:接收函数pthread_join中被等待线程的返回值</span><br>	<span class="hljs-type">int</span>  ret1,ret2,ret3,ret4;<br>	pthread_join(producer0, (<span class="hljs-type">void</span> **)&amp;ret1);<br>	pthread_join(producer1, (<span class="hljs-type">void</span> **)&amp;ret2);<br>	pthread_join(consumer0, (<span class="hljs-type">void</span> **)&amp;ret3);<br>	pthread_join(consumer1, (<span class="hljs-type">void</span> **)&amp;ret4);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------------------------------------------------------------------------\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;程序结束!\n&quot;</span>);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h3><p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130180507984.png" srcset="/img/loading.gif" lazyload alt="image-20211130180507984"></p>
<h2 id="实验总结和心得"><a href="#实验总结和心得" class="headerlink" title="实验总结和心得"></a>实验总结和心得</h2><ul>
<li><p>开始看到这个实验的题目时，头绪不多。因为所需要用到的Linux相关库<code>&lt;sys/shm.h&gt;</code>、<code>&lt;sys/sem.h&gt;</code>是之前没有接触过的。之后我通过查找资料，更好地了解如何使用它们实现生产者-消费者问题，具体使用的库函数可详见我上方的实验报告。这个过程中踩的一些坑被我记录下来：</p>
<ul>
<li>要额外定义一个void指针addr保存shmat的返回值，直接用循环队列指针*bf保存会导致类型不匹配。</li>
</ul>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130190423742.png" srcset="/img/loading.gif" lazyload alt="image-20211130190423742"></p>
<ul>
<li><p>刚开始运行时提示错误“共享内存创建失败”。</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130190738319.png" srcset="/img/loading.gif" lazyload alt="image-20211130190738319"></p>
<ul>
<li><p>这是因为创建共享内存的函数的第三个参数没有或上<code>IPC_CREAT</code>。</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130190943965.png" srcset="/img/loading.gif" lazyload alt="image-20211130190943965"></p>
</li>
</ul>
</li>
<li><p>如何打印缓冲区中的数据是需要细心考虑的：</p>
<p><img src="/2021/11/29/%E5%AE%9E%E9%AA%8C%E5%85%AD_%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20211130191121626.png" srcset="/img/loading.gif" lazyload alt="image-20211130191121626"></p>
<ul>
<li>in记录的是缓冲中下一个空位，in-1就是缓冲中最后一个满位。out记录的缓冲中第一个满位。对于一个表示缓冲区的循环队列（数组实现），in-1可能在out“前面”，即<code>in-1&lt;out</code>。这时就需要将last赋值为<code>in-1+MAX_BUFFER_SIZE</code>，做<code>% MAX_BUFFER_SIZE</code>后就可指向缓冲区数组的正确位置。</li>
</ul>
</li>
</ul>
</li>
<li><p>时间的处理主要用到<code>timeval</code>结构体，在前文也已进行说明。错误提示输出<code>perror()</code>和较美观的输出界面体现了人性化设计。</p>
</li>
<li><p>整个问题的实现可以由实验指导书的流程图较好地被标示出来，理解了这几个流程后，多点耐心、细心就可以完成代码实现。</p>
</li>
<li><p>对于思考题中的线程实现，则需要去了解库<code>&lt;pthread.h&gt;</code>和<code>&lt;semaphore.h&gt;</code>。整体框架和进程实现大同小异，不同点在思考题已做说明。</p>
</li>
<li><p>总的来说，这次实验让我对生产者-消费者问题的实现和基于Linux环境的C语言编程有了更加深刻的了解，较好地锻炼了我的逻辑思维和代码设计能力。</p>
</li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li>《【操作系统实验】Linux环境下用进程实现生产者消费者问题——C语言完整代码+详细实验报告》:<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44528283/article/details/114801233">https://blog.csdn.net/qq_44528283/article/details/114801233</a></li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/">操作系统实验</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均为博客作者本人编写整理，转载请联系作者！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/11/29/%E7%AC%AC%E4%BA%94%E6%AC%A1%E5%AE%9E%E9%AA%8C_%E9%93%B6%E8%A1%8C%E5%AE%B6%E7%AE%97%E6%B3%95/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">银行家算法的C++模拟</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/11/27/Healer%E7%9A%84%E5%AE%89%E8%A3%85/">
                        <span class="hidden-mobile">Healer的安装和初步使用</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.16/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"gI9ZupcpBXTdxJvxZZrrxydJ-gzGzoHsz","appKey":"Eew9XWCbMWVcoNrQzrg87EP3","path":"window.location.pathname","placeholder":"说点什么","avatar":"mp","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":"trut","recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="" target="_blank" rel="nofollow noopener"><span>Copyrights © 2021 Yuhan</span></a> <i class="iconfont icon-love"></i> <a href="" target="_blank" rel="nofollow noopener"><span>Xiayan</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js" ></script>
  
  
    <script defer src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.15.3/katex.min.css" />
  








  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?6da93a2e5d7f160e0f40b273ddbbddac";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
